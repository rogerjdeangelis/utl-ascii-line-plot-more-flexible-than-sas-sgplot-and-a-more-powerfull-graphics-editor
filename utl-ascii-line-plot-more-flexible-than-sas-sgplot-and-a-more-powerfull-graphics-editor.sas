%let pgm=utl-ascii-line-plot-more-flexible-than-sas-sgplot-and-a-more-powerfull-graphics-editor;

%stop_submission;

Ascii line plot more flexible than sas sgplot and a more powerfull graphics editor

    CONTENTS

      1 ascii line plot
      2 sas sgplot
        https://communities.sas.com/t5/user/viewprofilepage/user-id/173881

github
https://tinyurl.com/328t47z3
https://github.com/rogerjdeangelis/utl-ascii-line-plot-more-flexible-than-sas-sgplot-and-a-more-powerfull-graphics-editor

communities.sas.com
https://tinyurl.com/5ph4njzy
https://communities.sas.com/t5/Graphics-Programming/Displaying-Values-for-Histograms/m-p/843090#M23265

/*               _     _
 _ __  _ __ ___ | |__ | | ___ _ __ ___
| `_ \| `__/ _ \| `_ \| |/ _ \ `_ ` _ \
| |_) | | | (_) | |_) | |  __/ | | | | |
| .__/|_|  \___/|_.__/|_|\___|_| |_| |_|
|_|
*/

/*****************************************************************************************************************************************/
/*            INPUT                                         |       PROCESS           |                 OUTPUT                           */
/*            =====                                         |       =======           |                 ======                           */
/*                                                          |                         |                                                  */
/*                                                          |                         |                                                  */
/*        YEAR      X     Y                                 | 1 ASCII LINE PLOT       |                                                  */
/*                                                          | =================       |     -45 -35 -25 -15 -5 X 5  15  25  35  45       */
/*    1   1985    -45     1                                 |                         |    +-+---+---+---+---+---+---+---+---+---+--+    */
/*    2   2016    -45     2                                 | %let ys=                |   Y| Better thab sas sgplot (very accurate? |Y   */
/*    3   1930    -35     1                                 |  y12345678901234567890; |    | Great Graphics editor                  |    */
/*    4   1953    -35     2                                 |                         |    |                                        |    */
/*    5   1991    -35     3                                 | options ls=64;          |  25+ IN MEMORIAM    2021                    +25  */
/*        ....                                              | proc plot data=         |  24+ OF JOHN TUKEY  2015                    +24  */
/*   92   1979     25     4                                 |  have5(rename=y=&ys);   |  23+                2005    2022            +23  */
/*   93   1982     25     5                                 |  plot &ys*x=' ' $ year  |  22+                1997    2019            +22  */
/*   94   1996     25     6                                 |   /vspace=1 box;        |  21+                1995    2018            +21  */
/*   95   1977     35     1                                 | run;quit;               |  20+                1994    2017            +20  */
/*   96   2002     35     2                                 |                         |  19+                1993    2012            +19  */
/*   97   2003     45     1                                 |                         |  18+                1992    2011            +18  */
/*                                                          |                         |  17+                1990    2010            +17  */
/*                                                          |                         |  16+                198920041999            +16  */
/*                                                          |                         |  15+                197420011988            +15  */
/*  data have;                                              |                         |  14+                197319841987            +14  */
/*   informat year $4. x 2. y 2.;                           |                         |  13+                196619801976            +13  */
/*   input year x y @@;                                     |                         |  12+                196519751969            +12  */
/*  cards4;                                                 |                         |  11+            2014196119711963            +11  */
/*  1985 -45   1  1940  -5   4  1957   5   6  2010  15  17  |                         |  10+            2013195819681962            +10  */
/*  2016 -45   2  1941  -5   5  1959   5   7  2011  15  18  |                         |   9+            2009195019671956            + 9  */
/*  1930 -35   1  1945  -5   6  1964   5   8  2012  15  19  |                         |   8+            1986194819641955            + 8  */
/*  1953 -35   2  1946  -5   7  1967   5   9  2017  15  20  |                         |   7+            1983194619591952            + 7  */
/*  1991 -35   3  1948  -5   8  1968   5  10  2018  15  21  |                         |   6+    2020    19811945195719491996        + 6  */
/*  1998 -35   4  1950  -5   9  1971   5  11  2019  15  22  |                         |   5+    2008200719721941195419471982        + 5  */
/*  2008 -35   5  1958  -5  10  1975   5  12  2022  15  23  |                         |   4+    1998200619381940195119431979        + 4  */
/*  2020 -35   6  1961  -5  11  1980   5  13  1960  25   1  |                         |   3+    1991200019321934194419421978        + 3  */
/*  1931 -25   1  1965  -5  12  1984   5  14  1970  25   2  |                         |   2+201619531933192819291936193919702002    + 2  */
/*  1933 -25   2  1966  -5  13  2001   5  15  1978  25   3  |                         |   1+1985193019311927192619351937196019772003+ 1  */
/*  2000 -25   3  1973  -5  14  2004   5  16  1979  25   4  |                         |    |                                        |    */
/*  2006 -25   4  1974  -5  15  1937  15   1  1982  25   5  |                         |    +-+---+---+---+---+---+---+---+---+---+--+    */
/*  2007 -25   5  1989  -5  16  1939  15   2  1996  25   6  |                         |     -45 -35 -25 -15 -5 X 5  15  25  35  45       */
/*  1927 -15   1  1990  -5  17  1942  15   3  1977  35   1  |                         |                                                  */
/*  1928 -15   2  1992  -5  18  1943  15   4  2002  35   2  |                         |                                                  */
/*  1932 -15   3  1993  -5  19  1947  15   5  2003  45   1  |                         |                                                  */
/*  1938 -15   4  1994  -5  20  1949  15   6                |                         |                                                  */
/*  1972 -15   5  1995  -5  21  1952  15   7                |                         |                                                  */
/*  1981 -15   6  1997  -5  22  1955  15   8                |                         |                                                  */
/*  1983 -15   7  2005  -5  23  1956  15   9                |                         |                                                  */
/*  1986 -15   8  2015  -5  24  1962  15  10                |                         |                                                  */
/*  2009 -15   9  2021  -5  25  1963  15  11                |                         |                                                  */
/*  2013 -15  10  1935   5   1  1969  15  12                |                         |                                                  */
/*  2014 -15  11  1936   5   2  1976  15  13                |                         |                                                  */
/*  1926  -5   1  1944   5   3  1987  15  14                |                         |                                                  */
/*  1929  -5   2  1951   5   4  1988  15  15                |                         |                                                  */
/*  1934  -5   3  1954   5   5  1999  15  16                |                         |                                                  */
/*  ;;;;                                                    |                         |                                                  */
/*  run;quit;                                               |                         |                                                  */
/*                                                          |----------------------------------------------------------------------------*/
/*                                                          |                         |                                                  */
/*                                                          | 2 SAS SGPLOT            |                                                  */
/*                                                          | =============           |                                                  */
/*                                                          |                         |                                                  */
/*                                                          |  ods listing            |                                                  */
/*                                                          |    gpath="d:\png"       |                                                  */
/*                                                          |  ods graphics /         |                                                  */
/*                                                          |    reset                |                                                  */
/*                                                          |    imagename="hstpng"   |                                                  */
/*                                                          |    imagefmt=png;        |                                                  */
/*                                                          |                         |                                                  */
/*                                                          |  proc sgplot data=have; |                                                  */
/*                                                          |  scatter x=x y=y        |                                                  */
/*                                                          |   /markerchar=year      |                                                  */
/*                                                          |    markercharattrs      |                                                  */
/*                                                          |      =(size=10 )        |                                                  */
/*                                                          |    labelstrip;          |                                                  */
/*                                                          |  xaxis                  |                                                  */
/*                                                          |   values=               |                                                  */
/*                                                          |    (-90 to 90 by 10)    |                                                  */
/*                                                          |    min=-90 max=90       |                                                  */
/*                                                          |    valueshint;          |                                                  */
/*                                                          |  yaxis display=none     |                                                  */
/*                                                          |    offsetmin=0          |                                                  */
/*                                                          |    offsetmax=0.1        |                                                  */
/*                                                          |    min=1.6              |                                                  */
/*                                                          |    valueshint;          |                                                  */
/*                                                          |  run;                   |                                                  */
/*                                                          |                         |                                                  */
/*                                                          |  ods graphics/reset;    |                                                  */
/*****************************************************************************************************************************************/


/*                   _
(_)_ __  _ __  _   _| |_
| | `_ \| `_ \| | | | __|
| | | | | |_) | |_| | |_
|_|_| |_| .__/ \__,_|\__|
        |_|
*/

data have;
 informat year $4. x 2. y 2.;
 input year x y @@;
cards4;
1985 -45   1  1940  -5   4  1957   5   6  2010  15  17
2016 -45   2  1941  -5   5  1959   5   7  2011  15  18
1930 -35   1  1945  -5   6  1964   5   8  2012  15  19
1953 -35   2  1946  -5   7  1967   5   9  2017  15  20
1991 -35   3  1948  -5   8  1968   5  10  2018  15  21
1998 -35   4  1950  -5   9  1971   5  11  2019  15  22
2008 -35   5  1958  -5  10  1975   5  12  2022  15  23
2020 -35   6  1961  -5  11  1980   5  13  1960  25   1
1931 -25   1  1965  -5  12  1984   5  14  1970  25   2
1933 -25   2  1966  -5  13  2001   5  15  1978  25   3
2000 -25   3  1973  -5  14  2004   5  16  1979  25   4
2006 -25   4  1974  -5  15  1937  15   1  1982  25   5
2007 -25   5  1989  -5  16  1939  15   2  1996  25   6
1927 -15   1  1990  -5  17  1942  15   3  1977  35   1
1928 -15   2  1992  -5  18  1943  15   4  2002  35   2
1932 -15   3  1993  -5  19  1947  15   5  2003  45   1
1938 -15   4  1994  -5  20  1949  15   6
1972 -15   5  1995  -5  21  1952  15   7
1981 -15   6  1997  -5  22  1955  15   8
1983 -15   7  2005  -5  23  1956  15   9
1986 -15   8  2015  -5  24  1962  15  10
2009 -15   9  2021  -5  25  1963  15  11
2013 -15  10  1935   5   1  1969  15  12
2014 -15  11  1936   5   2  1976  15  13
1926  -5   1  1944   5   3  1987  15  14
1929  -5   2  1951   5   4  1988  15  15
1934  -5   3  1954   5   5  1999  15  16
;;;;
run;quit;

/**************************************************************************************************************************/
/*      YEAR      X     Y                                                                                                 */
/*                                                                                                                        */
/*  1   1985    -45     1                                                                                                 */
/*  2   2016    -45     2                                                                                                 */
/*  3   1930    -35     1                                                                                                 */
/*  4   1953    -35     2                                                                                                 */
/*  5   1991    -35     3                                                                                                 */
/*      ....                                                                                                              */
/* 92   1979     25     4                                                                                                 */
/* 93   1982     25     5                                                                                                 */
/* 94   1996     25     6                                                                                                 */
/* 95   1977     35     1                                                                                                 */
/* 96   2002     35     2                                                                                                 */
/* 97   2003     45     1                                                                                                 */
/**************************************************************************************************************************/

/*                  _ _   _ _                    _       _
/ |   __ _ ___  ___(_|_) | (_)_ __   ___   _ __ | | ___ | |_
| |  / _` / __|/ __| | | | | | `_ \ / _ \ | `_ \| |/ _ \| __|
| | | (_| \__ \ (__| | | | | | | | |  __/ | |_) | | (_) | |_
|_|  \__,_|___/\___|_|_| |_|_|_| |_|\___| | .__/|_|\___/ \__|
                                          |_|
*/

%let ys=
 y12345678901234567890;

options ls=64;
proc plot data=
 have5(rename=y=&ys);
 plot &ys*x=' ' $ year
  /vspace=1 box;
run;quit;


/**************************************************************************************************************************/
/*    -45 -35 -25 -15 -5 X 5  15  25  35  45                                                                              */
/*   +-+---+---+---+---+---+---+---+---+---+--+                                                                           */
/*  Y| Better thab sas sgplot (very accurate? |Y                                                                          */
/*   | Great Graphics editor                  |                                                                           */
/*   |                                        |                                                                           */
/* 25+ IN MEMORIAM    2021                    +25                                                                         */
/* 24+ OF JOHN TUKEY  2015                    +24                                                                         */
/* 23+                2005    2022            +23                                                                         */
/* 22+                1997    2019            +22                                                                         */
/* 21+                1995    2018            +21                                                                         */
/* 20+                1994    2017            +20                                                                         */
/* 19+                1993    2012            +19                                                                         */
/* 18+                1992    2011            +18                                                                         */
/* 17+                1990    2010            +17                                                                         */
/* 16+                198920041999            +16                                                                         */
/* 15+                197420011988            +15                                                                         */
/* 14+                197319841987            +14                                                                         */
/* 13+                196619801976            +13                                                                         */
/* 12+                196519751969            +12                                                                         */
/* 11+            2014196119711963            +11                                                                         */
/* 10+            2013195819681962            +10                                                                         */
/*  9+            2009195019671956            + 9                                                                         */
/*  8+            1986194819641955            + 8                                                                         */
/*  7+            1983194619591952            + 7                                                                         */
/*  6+    2020    19811945195719491996        + 6                                                                         */
/*  5+    2008200719721941195419471982        + 5                                                                         */
/*  4+    1998200619381940195119431979        + 4                                                                         */
/*  3+    1991200019321934194419421978        + 3                                                                         */
/*  2+201619531933192819291936193919702002    + 2                                                                         */
/*  1+1985193019311927192619351937196019772003+ 1                                                                         */
/*   |                                        |                                                                           */
/*   +-+---+---+---+---+---+---+---+---+---+--+                                                                           */
/*    -45 -35 -25 -15 -5 X 5  15  25  35  45                                                                              */
/**************************************************************************************************************************/

/*___                                    _       _
|___ \   ___  __ _ ___   ___  __ _ _ __ | | ___ | |_
  __) | / __|/ _` / __| / __|/ _` | `_ \| |/ _ \| __|
 / __/  \__ \ (_| \__ \ \__ \ (_| | |_) | | (_) | |_
|_____| |___/\__,_|___/ |___/\__, | .__/|_|\___/ \__|
                             |___/|_|
*/

ods listing
  gpath="d:\png"
ods graphics /
  reset
  imagename="hstpng"
  imagefmt=png;

proc sgplot data=have;
scatter x=x y=y
 /markerchar=year
  markercharattrs
    =(size=10 )
  labelstrip;
xaxis
 values=
  (-90 to 90 by 10)
  min=-90 max=90
  valueshint;
yaxis display=none
  offsetmin=0
  offsetmax=0.1
  min=1.6
  valueshint;
run;

ods graphics/reset;


*/ /**************************************************************************************************************************/
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /*
*/ /**************************************************************************************************************************/








































          INPUT                                                     PROCESS                                OUTPUT
          =====                                                     =======                                ======


      YEAR      X     Y                                       1 ASCII LINE PLOT
                                                              =================
  1   1985    -45     1
  2   2016    -45     2                                       %let ys=                                            X
  3   1930    -35     1                                        y12345678901234567890;          -45 -35 -25 -15 -5   5  15  25  35  45
  4   1953    -35     2                                                                       +-+---+---+---+---+---+---+---+---+---+--+
  5   1991    -35     3                                       options ls=64;                Y | Better thab sas sgplot (very accurate? | Y
      ....                                                    proc plot data=                 | Great Graphics editor                  |
 92   1979     25     4                                        have5(rename=y=&ys);           |                                        |
 93   1982     25     5                                        plot &ys*x=' ' $ year       25 +                2021                    + 25
 94   1996     25     6                                         /vspace=1 box;             24 +                2015                    + 24
 95   1977     35     1                                       run;quit;                    23 +                2005    2022            + 23
 96   2002     35     2                                                                    22 +                1997    2019            + 22
 97   2003     45     1                                                                    21 +                1995    2018            + 21
                                                                                           20 +                1994    2017            + 20
                                                                                           19 +                1993    2012            + 19
                                                                                           18 +                1992    2011            + 18
data have;                                                                                 17 +                1990    2010            + 17
 informat year $4. x 2. y 2.;                                                              16 +                198920041999            + 16
 input year x y @@;                                                                        15 +                197420011988            + 15
cards4;                                                                                    14 +                197319841987            + 14
1985 -45   1  1940  -5   4  1957   5   6  2010  15  17                                     13 +                196619801976            + 13
2016 -45   2  1941  -5   5  1959   5   7  2011  15  18                                     12 +                196519751969            + 12
1930 -35   1  1945  -5   6  1964   5   8  2012  15  19                                     11 +            2014196119711963            + 11
1953 -35   2  1946  -5   7  1967   5   9  2017  15  20                                     10 +            2013195819681962            + 10
1991 -35   3  1948  -5   8  1968   5  10  2018  15  21                                      9 +            2009195019671956            +  9
1998 -35   4  1950  -5   9  1971   5  11  2019  15  22                                      8 +            1986194819641955            +  8
2008 -35   5  1958  -5  10  1975   5  12  2022  15  23                                      7 +            1983194619591952            +  7
2020 -35   6  1961  -5  11  1980   5  13  1960  25   1                                      6 +    2020    19811945195719491996        +  6
1931 -25   1  1965  -5  12  1984   5  14  1970  25   2                                      5 +    2008200719721941195419471982        +  5
1933 -25   2  1966  -5  13  2001   5  15  1978  25   3                                      4 +    1998200619381940195119431979        +  4
2000 -25   3  1973  -5  14  2004   5  16  1979  25   4                                      3 +    1991200019321934194419421978        +  3
2006 -25   4  1974  -5  15  1937  15   1  1982  25   5                                      2 +201619531933192819291936193919702002    +  2
2007 -25   5  1989  -5  16  1939  15   2  1996  25   6                                      1 +1985193019311927192619351937196019772003+  1
1927 -15   1  1990  -5  17  1942  15   3  1977  35   1                                        |                                        |
1928 -15   2  1992  -5  18  1943  15   4  2002  35   2                                        +-+---+---+---+---+---+---+---+---+---+--+
1932 -15   3  1993  -5  19  1947  15   5  2003  45   1                                         -45 -35 -25 -15 -5   5  15  25  35  45
1938 -15   4  1994  -5  20  1949  15   6                                                                         X
1972 -15   5  1995  -5  21  1952  15   7
1981 -15   6  1997  -5  22  1955  15   8
1983 -15   7  2005  -5  23  1956  15   9
1986 -15   8  2015  -5  24  1962  15  10
2009 -15   9  2021  -5  25  1963  15  11
2013 -15  10  1935   5   1  1969  15  12
2014 -15  11  1936   5   2  1976  15  13
1926  -5   1  1944   5   3  1987  15  14
1929  -5   2  1951   5   4  1988  15  15
1934  -5   3  1954   5   5  1999  15  16
;;;;
run;quit;


                                                             2 SAS SGPLOT
                                                             =============

                                                              ods listing
                                                                gpath="d:\png"
                                                              ods graphics /
                                                                reset
                                                                imagename="hstpng"
                                                                imagefmt=png;

                                                              proc sgplot data=have;
                                                              scatter x=x y=y
                                                               /markerchar=year
                                                                markercharattrs
                                                                  =(size=10 )
                                                                labelstrip;
                                                              xaxis
                                                               values=
                                                                (-90 to 90 by 10)
                                                                min=-90 max=90
                                                                valueshint;
                                                              yaxis display=none
                                                                offsetmin=0
                                                                offsetmax=0.1
                                                                min=1.6
                                                                valueshint;
                                                              run;

                                                              ods graphics/reset;



%let ys=
 y12345678901234567890;

options ls=64;
proc plot data=
 have5(rename=y=&ys);
 plot &ys*x=' ' $ year
  /vspace=1 box;
run;quit;

                         X
      -45 -35 -25 -15 -5   5  15  25  35  45
     +-+---+---+---+---+---+---+---+---+---+--+
   Y | Better thab sas sgplot (very accurate? | Y
     | Great Graphics editor                  |
     |                                        |
  25 +                2021                    + 25
  24 +                2015                    + 24
  23 +                2005    2022            + 23
  22 +                1997    2019            + 22
  21 +                1995    2018            + 21
  20 +                1994    2017            + 20
  19 +                1993    2012            + 19
  18 +                1992    2011            + 18
  17 +                1990    2010            + 17
  16 +                198920041999            + 16
  15 +                197420011988            + 15
  14 +                197319841987            + 14
  13 +                196619801976            + 13
  12 +                196519751969            + 12
  11 +            2014196119711963            + 11
  10 +            2013195819681962            + 10
   9 +            2009195019671956            +  9
   8 +            1986194819641955            +  8
   7 +            1983194619591952            +  7
   6 +    2020    19811945195719491996        +  6
   5 +    2008200719721941195419471982        +  5
   4 +    1998200619381940195119431979        +  4
   3 +    1991200019321934194419421978        +  3
   2 +201619531933192819291936193919702002    +  2
   1 +1985193019311927192619351937196019772003+  1
     |                                        |
     +-+---+---+---+---+---+---+---+---+---+--+
      -45 -35 -25 -15 -5   5  15  25  35  45
                        X






/*
I like this picture.
*/
data have;
call streaminit(123);
do year=1926 to 2022;
 return=rand('normal');
 output;
end;
run;
proc sql;
create table have2 as
select year,(return-min(return))/(range(return)+0.5)-0.4 as return
 from have;
quit;
data have3;
 set have2;
 x=round(100*return,10)-5;
run;
proc sort data=have3 out=have4;
by x year;
run;
data have5;
 set have4;
 by x;
 if first.x then y=0;
 y+1;
run;



/*___                                    _       _
|___ \   ___  __ _ ___   ___  __ _ _ __ | | ___ | |_
  __) | / __|/ _` / __| / __|/ _` | `_ \| |/ _ \| __|
 / __/  \__ \ (_| \__ \ \__ \ (_| | |_) | | (_) | |_
|_____| |___/\__,_|___/ |___/\__, | .__/|_|\___/ \__|
                             |___/|_|
*/






































ods listing gpath="d:\png";
ods graphics /
  reset
  imagename="hstpng"
  imagefmt=png;

proc sgplot data=have;
scatter x=x y=y
 /markerchar=year
  markercharattrs
    =(size=10 )
  labelstrip;
xaxis
 values=
  (-90 to 90 by 10)
  min=-90 max=90
  valueshint;
yaxis display=none
  offsetmin=0
  offsetmax=0.1
  min=1.6
  valueshint;
run;

ods graphics / reset;



options ls=64;
proc plot data=
 have5(rename=y=&ys);
 plot &ys*x=' ' $ year
  /vspace=1 box;
run;quit;






























































































data have;
call streaminit(123);
do year=1926 to 2022;
 return=rand('normal');
 output;
end;
run;
proc sql;
create table have2 as
select year,(return-min(return))/(range(return)+0.5)-0.4 as return
 from have;
quit;
data have3;
 set have2;
 x=round(100*return,10)-5;
run;
proc sort data=have3 out=have4;
by x year;
run;
data have5;
 set have4;
 by x;
 if first.x then y=0;
 drop return;
 y+1;
run;

%let ys=y123456789012345678901234567890;
%let ys=y12345678901234567890;
options ls=64;
proc plot data=have5(rename=y=&ys);
  plot &ys*x=' ' $ year /vspace=1 box;
run;quit;


    --+---+---+---+---+---+---+---+---+---+---
890 |                                        |
    |                                        |
 25 +                2021                    +
 24 +                2015                    +
 23 +                2005    2022            +
 22 +                1997    2019            +
 21 +                1995    2018            +
 20 +                1994    2017            +
 19 +                1993    2012            +
 18 +                1992    2011            +
 17 +                1990    2010            +
 16 +                198920041999            +
 15 +                197420011988            +
 14 +                197319841987            +
 13 +                196619801976            +
 12 +                196519751969            +
 11 +            2014196119711963            +
 10 +            2013195819681962            +
  9 +            2009195019671956            +
  8 +            1986194819641955            +
  7 +            1983194619591952            +
  6 +    2020    19811945195719491996        +
  5 +    2008200719721941195419471982        +
  4 +    1998200619381940195119431979        +
  3 +    1991200019321934194419421978        +
  2 +201619531933192819291936193919702002    +
  1 +1985193019311927192619351937196019772003+
    |                                        |
    --+---+---+---+---+---+---+---+---+---+---
     -45 -35 -25 -15 -5   5  15  25  35  45

                        X


















%let pgm=utl-identify-changes-in-all-variable-values-between-phase1-and-phase2-trials;

%stop_submission;

Identify changes in all variable values between phase1 and phase2 trials;


   CONTENTS

       1 sas sql
       1 sas sql arrays
       2 r sql
       3 python sql
       4 excel sql

github
https://tinyurl.com/4e6yaap8
https://github.com/rogerjdeangelis/utl-identify-changes-in-all-variable-values-between-phase1-and-phase2-trials

related to
https://tinyurl.com/bdfczexy
https://communities.sas.com/t5/SAS-Programming/comparing-all-variable-values-between-two-datasets-and-high/m-p/843094#M333349


/**************************************************************************************************************************/
/* THIS IS WHAT WE WANT                                                                                                   */
/*                                                                                                                        */
/*  PATIENT   ADVERSE EVENT              DOSED              DRUG CHANGE        CHANGES BETWEEN PHASE1 & PHASE2            */
/*  VISIT    ==================      ===============     ==================    ==============================+            */
/*           PHASE1      PHASE2      PHASE1    PHASE2    PHASE1      PHASE2                                               */
/*  KEY      EVTOLD      EVTNEW      STYOLD    STYNEW    DRGOLD      DRGNEW     EVENT      STUDY        DRG               */
/*                                                                                                                        */
/* 101231    asthma      asthma       Yes       Yes      parace      parace    MATCHING    MATCHING   MATCHING            */
/* 101232    acidity     acidity      No        Yes      drg1        drg1      MATCHING    NO MATCH   MATCHING            */
/* 102321    asthma      asthma       Yes       Yes      sinarest              MATCHING    MATCHING   NO MATCH            */
/* 103431    vomit       vomit        Yes       Yes      drg5        drg4      MATCHING    MATCHING   NO MATCH            */
/* 103432    fever       pain         No        No       drg5        drg5      NO MATCH    MATCHING   MATCHING            */
/* 103433    pain                     Yes                drg4                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 103434                pan                    No                   drg5      P2 ONLY     P2 ONLY    P2 ONLY             */
/* 104201                fever                  Yes                  drg6      P2 ONLY     P2 ONLY    P2 ONLY             */
/* 104202    pain        pain         No        No       drg5        drg5      MATCHING    MATCHING   MATCHING            */
/* 104203                headache               No                   drg1      P2 ONLY     P2 ONLY    P2 ONLY             */
/* 104204    pain                     No                 drg1                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 104206    fever                    No                 drg6                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 104207    headache                 No                 5rg1                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 104208    pain                     yes                drg3                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 104233    headache                 Yes                drg3                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 104235    headache                 No                 drg1                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 104431    vomit                    Yes                drg4                  P1 ONLY     P1 ONLY    P1 ONLY             */
/* 107433                pain                   No                   drg5      P2 ONLY     P2 ONLY    P2 ONLY             */
/**************************************************************************************************************************/

/*                   _
(_)_ __  _ __  _   _| |_
| | `_ \| `_ \| | | | __|
| | | | | |_) | |_| | |_
|_|_| |_| .__/ \__,_|\__|
       _ |_|                _
 _ __ | |__   __ _ ___  ___/ |
| `_ \| `_ \ / _` / __|/ _ \ |
| |_) | | | | (_| \__ \  __/ |
| .__/|_| |_|\__,_|___/\___|_|
|_|
*/

options validvarname=upcase;
libname sd1 "d:/sd1";

data sd1.phase1;
length key $8.;
input PID$ AGE$ Visit$ phase$ event$ drg$ study$;
key=cats(PID, AGE, Visit);
keep key drg event study;
cards4;;;;
101 23 1 1 asthma parace Yes
102 32 1 1 asthma sinarest Yes
101 23 2 1 acidity drg1 No
103 43 1 1 vomit drg5 Yes
103 43 2 1 fever drg5 No
103 43 3 1 pain drg4 Yes
104 20 6 1 fever drg6 No
104 20 7 1 headache 5rg1 No
104 20 8 1 pain drg3 yes
104 23 3 1 headache drg3 Yes
104 20 2 1 pain drg5 No
104 20 4 1 pain drg1 No
104 43 1 1 vomit drg4 Yes
104 23 5 1 headache drg1 No
;;;;
run;quit;

/*     _                    ____
 _ __ | |__   __ _ ___  ___|___ \
| `_ \| `_ \ / _` / __|/ _ \ __) |
| |_) | | | | (_| \__ \  __// __/
| .__/|_| |_|\__,_|___/\___|_____|
|_|
*/

data sd1.phase2;
length key $8.;
input PID$ AGE$ Visit$ phase$ event$  drg$ study $;
key=cats(PID, AGE, Visit);
keep key event drg study;
cards4;
101 23 1 2 asthma parace Yes
102 32 1 2 asthma . Yes
101 23 2 2 acidity drg1 Yes
103 43 1 2 vomit drg4 Yes
103 43 2 2 pain drg5 No
103 43 4 2 pan drg5 No
107 43 3 2 pain drg5 No
104 20 1 1 fever drg6 Yes
104 20 3 1 headache drg1 No
104 20 2 1 pain drg5 No
;;;;
run;quit;

/**************************************************************************************************************************/
/*                 SD1.PHASE1                              SD1.PHASE 2                                                    */
/*                                                                                                                        */
/*  Obs     KEY      EVENT       DRG         STUDY    KEY      EVENT        DRG      STUDY                                */
/*                                                                                                                        */
/*  1    101231    asthma      parace       Yes      101231    asthma      parace     Yes                                 */
/*  2    102321    asthma      sinarest     Yes      102321    asthma                 Yes                                 */
/*  3    101232    acidity     drg1         No       101232    acidity     drg1       Yes                                 */
/*  4    103431    vomit       drg5         Yes      103431    vomit       drg4       Yes                                 */
/*  5    103432    fever       drg5         No       103432    pain        drg5       No                                  */
/*  6    103433    pain        drg4         Yes      103434    pan         drg5       No                                  */
/*  7    104206    fever       drg6         No       107433    pain        drg5       No                                  */
/*  8    104207    headache    5rg1         No       104201    fever       drg6       Yes                                 */
/*  9    104208    pain        drg3         yes      104203    headache    drg1       No                                  */
/* 10    104233    headache    drg3         Yes      104202    pain        drg5       No                                  */
/* 11    104202    pain        drg5         No                                                                            */
/* 12    104204    pain        drg1         No                                                                            */
/* 13    104431    vomit       drg4         Yes                                                                           */
/* 14    104235    headache    drg1         No                                                                            */
/**************************************************************************************************************************/

/*                             _
/ |  ___  __ _ ___   ___  __ _| |
| | / __|/ _` / __| / __|/ _` | |
| | \__ \ (_| \__ \ \__ \ (_| | |
|_| |___/\__,_|___/ |___/\__, |_|
                            |_|
*/

/*---- CREAT A MASTER LIST TO OF KEYS TO JOIN AGAINST ----*/

proc sql;
 create
    table allkey as
 select
     key
 from
    phase1
 union
    corr
 select
     key
 from
    phase2
;quit;

/**************************************************************************************************************************/
/* DISTINCT PRIMARY KEYS PHASE1 AND PHASE 2                                                                               */
/*                                                                                                                        */
/*  KEY                                                                                                                   */
/*                                                                                                                        */
/* 101231                                                                                                                 */
/* 101232                                                                                                                 */
/* 102321                                                                                                                 */
/* 103431                                                                                                                 */
/* 103432                                                                                                                 */
/* 103433                                                                                                                 */
/* 103434                                                                                                                 */
/* 104201                                                                                                                 */
/* 104202                                                                                                                 */
/* 104203                                                                                                                 */
/* 104204                                                                                                                 */
/* 104206                                                                                                                 */
/* 104207                                                                                                                 */
/* 104208                                                                                                                 */
/* 104233                                                                                                                 */
/* 104235                                                                                                                 */
/* 104431                                                                                                                 */
/* 107433                                                                                                                 */
/**************************************************************************************************************************/

/*---- LEFT JOIN AGAINST MASTER KEYS SO WE GET ALL THE DATA SIDE BY SIDE ----*/

proc datasets lib=work nolist nodetails;
 delete want;
run;quit;

proc sql;
   create
      table want as
   select
      l.key
     ,c.event as event_phase1
     ,r.event as event_phase2
     ,c.study as study_phase1
     ,r.study as study_phase2
     ,c.drg   as drg_phase1
     ,r.drg   as drg_phase2
     ,case
        when (missing(c.event) and not missing(r.event)) then "P2 ONLY "
        when (not missing(c.event) and missing(r.event)) then "P1 ONLY "
        when (c.event eq r.event                       ) then "MATCHING"
        when (c.event ne r.event                       ) then "NO MATCH"
        else "ERROR"
      end as event
     ,case
        when (missing(c.study) and not missing(r.study)) then "P2 ONLY "
        when (not missing(c.study) and missing(r.study)) then "P1 ONLY "
        when (c.study eq r.study                       ) then "MATCHING"
        when (c.study ne r.study                       ) then "NO MATCH"
        else "ERROR"
     end as study
     ,case
        when (missing(c.drg) and not missing(r.drg)) then "P2 ONLY "
        when (not missing(c.drg) and missing(r.drg)) then "P1 ONLY "
        when (c.drg eq r.drg                       ) then "MATCHING"
        when (c.drg ne r.drg                       ) then "NO MATCH"
        else "ERROR"
     end as drg
   from
      allkey as l
   left join sd1.phase1 as c on l.key=c.key
   left join sd1.phase2 as r on l.key=r.key
;quit;


/**************************************************************************************************************************/
/*                  EVENT_      EVENT_      STUDY_    STUDY_    DRG_         DRG_                                         */
/* Obs     KEY      PHASE1      PHASE2      PHASE1    PHASE2    PHASE1      PHASE2     EVENT       STUDY        DRG       */
/*                                                                                                                        */
/*   1    101231    asthma      asthma       Yes       Yes      parace      parace    MATCHING    MATCHING    MATCHING    */
/*   2    101232    acidity     acidity      No        Yes      drg1        drg1      MATCHING    NO MATCH    MATCHING    */
/*   3    102321    asthma      asthma       Yes       Yes      sinarest              MATCHING    MATCHING    P1 ONLY     */
/*   4    103431    vomit       vomit        Yes       Yes      drg5        drg4      MATCHING    MATCHING    NO MATCH    */
/*   5    103432    fever       pain         No        No       drg5        drg5      NO MATCH    MATCHING    MATCHING    */
/*   6    103433    pain                     Yes                drg4                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*   7    103434                pan                    No                   drg5      P2 ONLY     P2 ONLY     P2 ONLY     */
/*   8    104201                fever                  Yes                  drg6      P2 ONLY     P2 ONLY     P2 ONLY     */
/*   9    104202    pain        pain         No        No       drg5        drg5      MATCHING    MATCHING    MATCHING    */
/*  10    104203                headache               No                   drg1      P2 ONLY     P2 ONLY     P2 ONLY     */
/*  11    104204    pain                     No                 drg1                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*  12    104206    fever                    No                 drg6                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*  13    104207    headache                 No                 5rg1                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*  14    104208    pain                     yes                drg3                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*  15    104233    headache                 Yes                drg3                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*  16    104235    headache                 No                 drg1                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*  17    104431    vomit                    Yes                drg4                  P1 ONLY     P1 ONLY     P1 ONLY     */
/*  18    107433                pain                   No                   drg5      P2 ONLY     P2 ONLY     P2 ONLY     */
/**************************************************************************************************************************/

/*___                              _
|___ \   ___  __ _ ___   ___  __ _| |   __ _ _ __ _ __ __ _ _   _ ___
  __) | / __|/ _` / __| / __|/ _` | |  / _` | `__| `__/ _` | | | / __|
 / __/  \__ \ (_| \__ \ \__ \ (_| | | | (_| | |  | | | (_| | |_| \__ \
|_____| |___/\__,_|___/ |___/\__, |_|  \__,_|_|  |_|  \__,_|\__, |___/
                                |_|                         |___/
*/

%array(_vr,values=EVENT DRG STUDY);

ARRAY ELEMENTS

%put &_vr1;  * GLOBAL _VR1 EVENT  ;
%put &_vr2;  * GLOBAL _VR2 DRG    ;
%put &_vr3;  * GLOBAL _VR3 STUDY  ;
%put &_vrn;  * GLOBAL _VRN 3      ;


proc datasets lib=work nolist nodetails;
 delete want;
run;quit;

proc sql;
   create
      table want as
   select
      l.key
  ,%do_over(_vr,phrase=%str(
      c.? as ?_phase1
     ,r.? as ?_phase2
     ,case
        when (missing(c.?) and not missing(r.?)) then "P2 ONLY "
        when (not missing(c.?) and missing(r.?)) then "P1 ONLY "
        when (c.? eq r.?                       ) then "MATCHING"
        when (c.? ne r.?                       ) then "NO MATCH"
        else "ERROR"
     end as ?),between=comma)
   from
      allkey as l
   left join sd1.phase1 as c on l.key=c.key
   left join sd1.phase2 as r on l.key=r.key
;quit;

/*---- CLEAN UP MACRO ARRAY ----*/

%arraydelete(_vr);

/*____                    _
|___ /   _ __   ___  __ _| |
  |_ \  | `__| / __|/ _` | |
 ___) | | |    \__ \ (_| | |
|____/  |_|    |___/\__, |_|
                       |_|
*/

proc datasets lib=sd1 nolist nodetails;
 delete rwant;
run;quit;

%utl_rbeginx;
parmcards4;
library(haven)
library(sqldf)
source("c:/oto/fn_tosas9x.R")
phase1<-read_sas("d:/sd1/phase1.sas7bdat")
phase2<-read_sas("d:/sd1/phase2.sas7bdat")
want <- sqldf('
 with
   allkey  as (
     select
         key
     from
        phase1
     union
     select
         key
     from
        phase2)
   select
      l.key
     ,c.event as event_phase1
     ,r.event as event_phase2
     ,c.study as study_phase1
     ,r.study as study_phase2
     ,c.drg   as drg_phase1
     ,r.drg   as drg_phase2
     ,case
        when (c.event is null and r.event is not null) then "P2 ONLY "
        when (c.event is not null and r.event is null) then "P1 ONLY "
        when (c.event =  r.event                     ) then "MATCHING"
        when (c.event <> r.event                     ) then "NO MATCH"
        else "ERROR"
      end as event
     ,case
        when (c.study is null and r.study is not null) then "P2 ONLY "
        when (c.study is not null and r.study is null) then "P1 ONLY "
        when (c.study =  r.study                     ) then "MATCHING"
        when (c.study <> r.study                     ) then "NO MATCH"
        else "ERROR"
     end as study
     ,case
        when (c.drg is null and r.drg is not null) then "P2 ONLY "
        when (c.drg is not null and r.drg is null) then "P1 ONLY "
        when (c.drg =  r.drg                     ) then "MATCHING"
        when (c.drg <> r.drg                     ) then "NO MATCH"
        else "ERROR"
     end as drg
   from
      allkey as l
      left join phase1 as c on l.key=c.key
      left join phase2 as r on l.key=r.key
   ')
want
fn_tosas9x(
      inp    = want
     ,outlib ="d:/sd1/"
     ,outdsn ="rwant"
     )
;;;;
%utl_rendx;

proc print data=sd1.rwant;
run;quit;

/***************************************************************************************************************************/
/* R                                                                                                                       */
/* want                                                                                                                    */
/*                                                                                                                         */
/*     key event_phase1 event_phase2 study_phase1 study_phase2 drg_phase1  drg_phase2    event    study      drg           */
/*                                                                                                                         */
/*  101231       asthma       asthma          Yes          Yes     parace      parace MATCHING MATCHING MATCHING           */
/*  101232      acidity      acidity           No          Yes       drg1        drg1 MATCHING NO MATCH MATCHING           */
/*  102321       asthma       asthma          Yes          Yes   sinarest             MATCHING MATCHING NO MATCH           */
/*  103431        vomit        vomit          Yes          Yes       drg5        drg4 MATCHING MATCHING NO MATCH           */
/*  103432        fever         pain           No           No       drg5        drg5 NO MATCH MATCHING MATCHING           */
/*  103433         pain         <NA>          Yes         <NA>       drg4        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  103434         <NA>          pan         <NA>           No       <NA>        drg5 P2 ONLY  P2 ONLY  P2 ONLY            */
/*  104201         <NA>        fever         <NA>          Yes       <NA>        drg6 P2 ONLY  P2 ONLY  P2 ONLY            */
/*  104202         pain         pain           No           No       drg5        drg5 MATCHING MATCHING MATCHING           */
/*  104203         <NA>     headache         <NA>           No       <NA>        drg1 P2 ONLY  P2 ONLY  P2 ONLY            */
/*  104204         pain         <NA>           No         <NA>       drg1        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  104206        fever         <NA>           No         <NA>       drg6        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  104207     headache         <NA>           No         <NA>       5rg1        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  104208         pain         <NA>          yes         <NA>       drg3        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  104233     headache         <NA>          Yes         <NA>       drg3        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  104235     headache         <NA>           No         <NA>       drg1        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  104431        vomit         <NA>          Yes         <NA>       drg4        <NA> P1 ONLY  P1 ONLY  P1 ONLY            */
/*  107433         <NA>         pain         <NA>           No       <NA>        drg5 P2 ONLY  P2 ONLY  P2 ONLY            */
/*                                                                                                                         */
/* SAS                                                                                                                     */
/*                     EVENT_      EVENT_      STUDY_    STUDY_    DRG_         DRG_                                       */
/*  ROWNAMES  KEY      PHASE1      PHASE2      PHASE1    PHASE2    PHASE1      PHASE2     EVENT       STUDY        DRG     */
/*                                                                                                                         */
/*      1    101231    asthma      asthma       Yes       Yes      parace      parace    MATCHING    MATCHING    MATCHING  */
/*      2    101232    acidity     acidity      No        Yes      drg1        drg1      MATCHING    NO MATCH    MATCHING  */
/*      3    102321    asthma      asthma       Yes       Yes      sinarest              MATCHING    MATCHING    NO MATCH  */
/*      4    103431    vomit       vomit        Yes       Yes      drg5        drg4      MATCHING    MATCHING    NO MATCH  */
/*      5    103432    fever       pain         No        No       drg5        drg5      NO MATCH    MATCHING    MATCHING  */
/*      6    103433    pain                     Yes                drg4                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*      7    103434                pan                    No                   drg5      P2 ONLY     P2 ONLY     P2 ONLY   */
/*      8    104201                fever                  Yes                  drg6      P2 ONLY     P2 ONLY     P2 ONLY   */
/*      9    104202    pain        pain         No        No       drg5        drg5      MATCHING    MATCHING    MATCHING  */
/*     10    104203                headache               No                   drg1      P2 ONLY     P2 ONLY     P2 ONLY   */
/*     11    104204    pain                     No                 drg1                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*     12    104206    fever                    No                 drg6                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*     13    104207    headache                 No                 5rg1                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*     14    104208    pain                     yes                drg3                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*     15    104233    headache                 Yes                drg3                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*     16    104235    headache                 No                 drg1                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*     17    104431    vomit                    Yes                drg4                  P1 ONLY     P1 ONLY     P1 ONLY   */
/*     18    107433                pain                   No                   drg5      P2 ONLY     P2 ONLY     P2 ONLY   */
/***************************************************************************************************************************/

/*  _                 _   _                             _
| || |    _ __  _   _| |_| |__   ___  _ __    ___  __ _| |
| || |_  | `_ \| | | | __| `_ \ / _ \| `_ \  / __|/ _` | |
|__   _| | |_) | |_| | |_| | | | (_) | | | | \__ \ (_| | |
   |_|   | .__/ \__, |\__|_| |_|\___/|_| |_| |___/\__, |_|
         |_|    |___/                                |_|
*/

proc datasets lib=sd1 nolist nodetails;
 delete pywant;
run;quit;

%utl_pybeginx;
parmcards4;
exec(open('c:/oto/fn_python.py').read());
phase1,meta = ps.read_sas7bdat('d:/sd1/phase1.sas7bdat');
phase2,meta = ps.read_sas7bdat('d:/sd1/phase2.sas7bdat');
want=pdsql('''
 with
   allkey  as (
     select
         key
     from
        phase1
     union
     select
         key
     from
        phase2)
   select
      l.key
     ,c.event as event_phase1
     ,r.event as event_phase2
     ,c.study as study_phase1
     ,r.study as study_phase2
     ,c.drg   as drg_phase1
     ,r.drg   as drg_phase2
     ,case
        when (c.event is null and r.event is not null) then "P2 ONLY "
        when (c.event is not null and r.event is null) then "P1 ONLY "
        when (c.event =  r.event                     ) then "MATCHING"
        when (c.event <> r.event                     ) then "NO MATCH"
        else "ERROR"
      end as event
     ,case
        when (c.study is null and r.study is not null) then "P2 ONLY "
        when (c.study is not null and r.study is null) then "P1 ONLY "
        when (c.study =  r.study                     ) then "MATCHING"
        when (c.study <> r.study                     ) then "NO MATCH"
        else "ERROR"
     end as study
     ,case
        when (c.drg is null and r.drg is not null) then "P2 ONLY "
        when (c.drg is not null and r.drg is null) then "P1 ONLY "
        when (c.drg =  r.drg                     ) then "MATCHING"
        when (c.drg <> r.drg                     ) then "NO MATCH"
        else "ERROR"
     end as drg
   from
      allkey as l
      left join phase1 as c on l.key=c.key
      left join phase2 as r on l.key=r.key
   ''');
print(want);
fn_tosas9x(want,outlib='d:/sd1/',outdsn='pywant',timeest=3);
;;;;
%utl_pyendx;

proc print data=sd1.pywant;
run;quit;

proc print data=sd1.pywant;
run;quit;

/**************************************************************************************************************************/
/* PYTHON                                                                                                                 */
/*        key event_phase1 event_phase2  ...     event     study       drg                                                */
/*                                                                                                                        */
/* 0   101231       asthma       asthma  ...  MATCHING  MATCHING  MATCHING                                                */
/* 1   101232      acidity      acidity  ...  MATCHING  NO MATCH  MATCHING                                                */
/* 2   102321       asthma       asthma  ...  MATCHING  MATCHING  NO MATCH                                                */
/* 3   103431        vomit        vomit  ...  MATCHING  MATCHING  NO MATCH                                                */
/* 4   103432        fever         pain  ...  NO MATCH  MATCHING  MATCHING                                                */
/* 5   103433         pain         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 6   103434         None          pan  ...  P2 ONLY   P2 ONLY   P2 ONLY                                                 */
/* 7   104201         None        fever  ...  P2 ONLY   P2 ONLY   P2 ONLY                                                 */
/* 8   104202         pain         pain  ...  MATCHING  MATCHING  MATCHING                                                */
/* 9   104203         None     headache  ...  P2 ONLY   P2 ONLY   P2 ONLY                                                 */
/* 10  104204         pain         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 11  104206        fever         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 12  104207     headache         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 13  104208         pain         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 14  104233     headache         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 15  104235     headache         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 16  104431        vomit         None  ...  P1 ONLY   P1 ONLY   P1 ONLY                                                 */
/* 17  107433         None         pain  ...  P2 ONLY   P2 ONLY   P2 ONLY                                                 */
/*                                                                                                                        */
/* SAS                                                                                                                    */
/*           EVENT_      EVENT_      STUDY_    STUDY_    DRG_         DRG_                                                */
/*  KEY      PHASE1      PHASE2      PHASE1    PHASE2    PHASE1      PHASE2     EVENT       STUDY        DRG              */
/*                                                                                                                        */
/* 101231    asthma      asthma       Yes       Yes      parace      parace    MATCHING    MATCHING    MATCHING           */
/* 101232    acidity     acidity      No        Yes      drg1        drg1      MATCHING    NO MATCH    MATCHING           */
/* 102321    asthma      asthma       Yes       Yes      sinarest              MATCHING    MATCHING    NO MATCH           */
/* 103431    vomit       vomit        Yes       Yes      drg5        drg4      MATCHING    MATCHING    NO MATCH           */
/* 103432    fever       pain         No        No       drg5        drg5      NO MATCH    MATCHING    MATCHING           */
/* 103433    pain                     Yes                drg4                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 103434                pan                    No                   drg5      P2 ONLY     P2 ONLY     P2 ONLY            */
/* 104201                fever                  Yes                  drg6      P2 ONLY     P2 ONLY     P2 ONLY            */
/* 104202    pain        pain         No        No       drg5        drg5      MATCHING    MATCHING    MATCHING           */
/* 104203                headache               No                   drg1      P2 ONLY     P2 ONLY     P2 ONLY            */
/* 104204    pain                     No                 drg1                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 104206    fever                    No                 drg6                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 104207    headache                 No                 5rg1                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 104208    pain                     yes                drg3                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 104233    headache                 Yes                drg3                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 104235    headache                 No                 drg1                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 104431    vomit                    Yes                drg4                  P1 ONLY     P1 ONLY     P1 ONLY            */
/* 107433                pain                   No                   drg5      P2 ONLY     P2 ONLY     P2 ONLY            */
/**************************************************************************************************************************/

%utlfkil(d:/xls/wantxl.xlsx);

%utl_rbeginx;
parmcards4;
library(openxlsx)
library(sqldf)
library(haven)
phase1<-read_sas("d:/sd1/phase1.sas7bdat")
phase2<-read_sas("d:/sd1/phase2.sas7bdat")
wb <- createWorkbook()
addWorksheet(wb, "phase1")
writeData(wb, sheet = "phase1", x = phase1)
addWorksheet(wb, "phase2")
writeData(wb, sheet = "phase2", x = phase2)
saveWorkbook(
    wb
   ,"d:/xls/wantxl.xlsx"
   ,overwrite=TRUE)
;;;;
%utl_rendx;

%utl_rbeginx;
parmcards4;
library(openxlsx)
library(sqldf)
source("c:/oto/fn_tosas9x.R")
 wb<-loadWorkbook("d:/xls/wantxl.xlsx")
 phase1<-read.xlsx(wb,"phase1")
 phase2<-read.xlsx(wb,"phase2")
 addWorksheet(wb, "want")
 want <- sqldf('
 with
   allkey  as (
     select
         key
     from
        phase1
     union
     select
         key
     from
        phase2)
   select
      l.key
     ,c.event as event_phase1
     ,r.event as event_phase2
     ,c.study as study_phase1
     ,r.study as study_phase2
     ,c.drg   as drg_phase1
     ,r.drg   as drg_phase2
     ,case
        when (c.event is null and r.event is not null) then "P2 ONLY "
        when (c.event is not null and r.event is null) then "P1 ONLY "
        when (c.event =  r.event                     ) then "MATCHING"
        when (c.event <> r.event                     ) then "NO MATCH"
        else "ERROR"
      end as event
     ,case
        when (c.study is null and r.study is not null) then "P2 ONLY "
        when (c.study is not null and r.study is null) then "P1 ONLY "
        when (c.study =  r.study                     ) then "MATCHING"
        when (c.study <> r.study                     ) then "NO MATCH"
        else "ERROR"
     end as study
     ,case
        when (c.drg is null and r.drg is not null) then "P2 ONLY "
        when (c.drg is not null and r.drg is null) then "P1 ONLY "
        when (c.drg =  r.drg                     ) then "MATCHING"
        when (c.drg <> r.drg                     ) then "NO MATCH"
        else "ERROR"
     end as drg
   from
      allkey as l
      left join phase1 as c on l.key=c.key
      left join phase2 as r on l.key=r.key
   ')
 print(want)
 writeData(wb,sheet="want",x=want)
 saveWorkbook(
     wb
    ,"d:/xls/wantxl.xlsx"
    ,overwrite=TRUE)
fn_tosas9x(
      inp    = want
     ,outlib ="d:/sd1/"
     ,outdsn ="want"
     )
;;;;
%utl_rendx;

proc print data=sd1.want;
run;quit;

/**************************************************************************************************************************/
/* -----------------------+                                                                                               */
/* | A1| fx    |  KEY     |                                                                                               */
/* -------------------------------------------------------------------------------------------------+                     */
/* [_] |    A  |    B   |    C    |    E    |     F   |    G  |  H   |    I   |    J     |   K      |                     */
/* -------------------------------------------------------------------------------------------------|                     */
/*  1 | KEY    | EVTOLD |  EVTNEW |   STYOLD|  STYNEW | DRGOLD|DRGNEW| EVENT  |   STUDY  |     DRG  |                     */
/*  --|-------+-----------------------------------------------+---------+-------------------+-------|                     */
/*  2  101231 | asthma  | asthma  | Yes     | Yes     |parace |parace| MATCHING| NO MATCH | MATCHING|                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/*  3  101232 | acidity | acidity | No      | No      | drg1  | drg1 | MATCHING| MATCHING | NO MATCH|                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/*  4  102321 | asthma  | asthma  | Yes     | Yes     | sinart| sinar| MATCHING| MATCHING | NO MATCH|                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/*  5  103431 | vomit   | vomit   | Yes     | Yes     | drg5  | drg5 | NO MATCH| MATCHING | MATCHING|                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/*  6  103432 | fever   | fever   | No      | No      | drg5  | drg5 | P1 ONLY | P1 ONLY  | P1 ONLY |                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/*  7  103433 | pain    | pain    | Yes     | Yes     | drg4  | drg4 | P2 ONLY | P2 ONLY  | P2 ONLY |                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/*  8  104202 | pain    | pain    | No      | No      | drg5  | drg5 | P2 ONLY | P2 ONLY  | P2 ONLY |                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/*  9  104204 | pain    | pain    | No      | No      | drg1  | drg1 | MATCHING| MATCHING | MATCHING|                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/* 10  104206 | fever   | fever   | No      | No      | drg6  | drg6 | P2 ONLY | P2 ONLY  | P2 ONLY |                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/* 11  104207 | headache| headache| No      | No      | 5rg1  | 5rg1 | P1 ONLY | P1 ONLY  | P1 ONLY |                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/* 12  104208 | pain    | pain    | yes     | yes     | drg3  | drg3 | P1 ONLY | P1 ONLY  | P1 ONLY |                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/* 13  104233 | headache| headache| Yes     | Yes     | drg3  | drg3 | P1 ONLY | P1 ONLY  | P1 ONLY |                     */
/*   - ---------------------------------------------------------------------------------------------|                     */
/* 14  104235 | headache| headache| No      | No      | drg1  | drg1 | P1 ONLY | P1 ONLY  | P1 ONLY |                     */
/*   - -------------------------------------------------------------------------------------------- |                     */
/* 15  104431 | vomit   | vomit   | Yes     | Yes     | drg4  | drg4 | P1 ONLY | P1 ONLY  | P1 ONLY |                     */
/*  |-|--------------+---------+---------+---------+----------------------------+-----------+-------|                     */
/*  |-|....................                                                                                               */
/*  [WANT]                                                                                                                */
/**************************************************************************************************************************/

/*              _
  ___ _ __   __| |
 / _ \ `_ \ / _` |
|  __/ | | | (_| |
 \___|_| |_|\__,_|

*/
